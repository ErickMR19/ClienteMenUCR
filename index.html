<!doctype html>
<html lang="es">
<head>
    <title>MenUCR</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta charset="utf-8" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous" />
    <link rel="stylesheet" href="bower_components/sidebar-v2/css/gmaps-sidebar.css" />
    <script src="https://www.google.com/recaptcha/api.js?hl=es-419" async defer></script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }
        
        html,
        body,
        #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }
    </style>
    <style>
        .wrapper-list > div {
            float: left;
            text-align: center;
            font-size: 1.3em;
            margin-top: 5px;
            margin-bottom: 5px;
            height: 125px;
        }
        
        @media (max-width: 459px) {
            .wrapper-list > div {
                width: 98%;
            }
        }
        
        @media (min-width: 460px) and (max-width: 767px) {
            .wrapper-list > div {
                width: 48%;
            }
            .wrapper-list > div:nth-child(even) {
                margin-left: 10px;
            }
        }
        
        @media (min-width: 768px) and (max-width: 1199px) {
            .wrapper-list > div {
                width: 98%;
            }
        }
        
        @media (min-width: 1200px) {
            .wrapper-list > div {
                width: 48%;
            }
            .wrapper-list > div:nth-child(even) {
                margin-left: 10px;
            }
        }
        
        .thumbnail > .content-t {
            background-color: #F0F0F0;
            height: 100%;
            padding: 3px;
            padding-top: 6px;
            padding-bottom: 15px;
        }
        
        .wrapper-list div.thumbnail:hover {
            border-color: #41ade7;
        }
        
        .wrapper-list div:hover > .content-t {
            background-color: #E0E0E0;
        }
        
        .sidebar-header,
        .sidebar-tabs > ul > li.active {
            color: #FFF;
            background-color: #41ade7;
        }
        
        #mensaje-recaptcha div {
            margin: 0 auto;
        }
        
        
        div.contenedor-nombre {
            height: 70px;
            position: relative;
            text-align: center;
        }
        
        div.contenedor-nombre p {
            margin: 0;
            position: absolute;
            top: 50%;
            transform: translate(0, -50%);
            text-align: center;
            width: 100%;
        }
        
        #lista-sodas {
            padding-left: 10px;
        }
        
        #lista-sodas .sidebar-header {
            padding-left: 40px;
        }
        
        #ajustes h4 {
            display: inline-block;
            font-weight: 600;
        }
        
        #nombre-sede {
            font-size: 1.3em;            
        }
        
        #horario-soda > div{
            font-size: 1.1em;
            padding: 7px;
            text-align: center;
        }        
        
        #imagen_soda {
            max-height: 250px;
            max-width: 100%;
        }
        
        .sidebar-pane > div {
          padding-top: 5px;
        }
    </style>
    <script>
        var URL_Peticiones =  "http://menucr-jeancarlozuniga17.c9users.io/src";
    </script>
</head>

<body onload="initialize()">
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist" id="opciones-soda">
                <li class="disabled"><a id="botonInfo" href="#informacion-soda" role="tab" title="Información de la Soda"><i class="fa fa-cutlery"></i></a></li>
                <li class="disabled"><a href="#menu-soda" role="tab" title="Menú de la Soda"><i class="fa fa-file-text"></i></a></li>
                <li class="disabled"><a href="#mensaje-soda" role="tab" title="Mensaje a la Soda"><i class="fa fa-envelope"></i></a></li>
            </ul>

            <ul role="tablist">
                <li><a href="#lista-sodas" role="tab" title="Lista de Sodas"><i class="fa fa-list"></i></a></li>
                <li><a href="#ajustes" role="tab" title="Ajustes"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">

            <div class="sidebar-pane" id="informacion-soda">
                <h1 class="sidebar-header">
                    <span class="nombre-soda-actual"></span>
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <div></div>
            </div>

            <div class="sidebar-pane" id="menu-soda">
                <h1 class="sidebar-header">					
                    <span class="nombre-soda-actual"></span>
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <div></div>
            </div>

            <div class="sidebar-pane" id="mensaje-soda">
                <h1 class="sidebar-header">
                    <span class="nombre-soda-actual"></span>
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <div>
                    <form id="form-enviar" onsubmit="return validarYEnviarMensaje(this);" data-idsoda="0" class="form">

                        <div class="form-group">
                            <input type="text" id="mensaje-nombre" class="form-control" placeholder="Ingrese su nombre" required="required" />
                        </div>
                        <div class="form-group">
                            <input type="email" id="mensaje-email" class="form-control" placeholder="Ingrese su correo electrónico" required="required" />
                        </div>
                        <div class="form-group">
                            <textarea id="mensaje-cuerpo" class="form-control" placeholder="Escriba su mensaje" required="required"></textarea>
                        </div>
                        <div id="mensaje-recaptcha" class="form-group g-recaptcha" data-sitekey="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI" data-size="compact" data-callback="ocultarErrorCaptcha" data-expired-callback="captchaExpirado">
                        </div>
                        <div id="alertaCaptcha" class="alert alert-danger" role="alert" style="display:none">Por favor complete el CAPTCHA</div>
                        <button id="button_enviar" type="submit" class="btn btn-default" style="display:block; margin: 0 auto;">Enviar</button>
                        <script>
                            var captchaIncompleto = true;

                            function enviarPeticion(idSoda, form) {
                                // TODO: tomar todos los datos y con un llamado AJAX al URL para enviar el mensaje indicando el id correspondiente      
                                
                                $.ajax({
                                    method: 'POST',
                                    data: {name: $('#mensaje-nombre').val(), email: $('#mensaje-email').val(),body: $('#mensaje-cuerpo').val(), recaptchaResponse : grecaptcha.getResponse()},
                                    accepts: { json : 'application/json' },
                                    headers: {          
                                     Accept : "application/json; charset=utf-8"
                                    },
                                    url : URL_Peticiones+"/restaurants/sendEmail/"+idSoda
                                }).done( function( json ) {
                                    console.log(json)
                                    if(json.respuesta.Exito){                                                                  
                                        form.reset();
                                        grecaptcha.reset();
                                    }
                                });
                            }

                            function validarYEnviarMensaje(form) {
                                if (captchaIncompleto) document.getElementById('alertaCaptcha').style.display = 'block';
                                else enviarPeticion(form.getAttribute('data-idsoda'), form);
                                return false;
                            }

                            function ocultarErrorCaptcha() {
                                captchaIncompleto = false;
                                document.getElementById('alertaCaptcha').style.display = 'none';
                            }

                            function captchaExpirado() {
                                captchaIncompleto = true;
                            }
                        </script>
                    </form>
                </div>
            </div>

            <div class="sidebar-pane" id="lista-sodas">
                <h1 class="sidebar-header">Sodas<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <div></div>
            </div>

            <div class="sidebar-pane" id="ajustes">
                <h1 class="sidebar-header">Ajustes<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>

                <div><h4>Sede actual: </h4> <span id="nombre-sede"> </span>
                    <script>
                    function cambiar_sede(id, lat, long, nombre)
                    {
                        var point = new google.maps.LatLng(lat, long);
                        map.setCenter(point);
                        document.getElementById('nombre-sede').textContent = nombre;
                        document.getElementById('div_sedes').style.display = "none";
                        infoWindow.close();
                        google.maps.event.trigger(infoWindow, 'closeclick');
                        insertarSodas(id);
                    }
                    function cancelar()
                    {
                        //Vuelve a ser seleccionable la opcion de cambiar
                        document.getElementById('cambia_sedeBTN').disabled = false;
                        document.getElementById('div_sedes').style.display = "none";
                    }
                    function mostrarSedes()
                    {
                        document.getElementById('div_sedes').style.display = "block";
                        document.getElementById('cambia_sedeBTN').disabled = false;
                    }
                    function recuperarSedes()
                    {
                        
                        $.ajax({
                            accepts: { json : 'application/json' },
                            headers: {          
                             Accept : "application/json; charset=utf-8"
                            },
                            url : URL_Peticiones+"/headquarters/"
                        }).done( function( json ) {
                                var div_opciones_sodas = document.createElement('div');
                                div_opciones_sodas.id = "div_sedes";
                                div_opciones_sodas.style.display = "none"
                                div_opciones_sodas.innerHTML = "<br>";

                                //Se recorre el json para obtener sus valores
                                for(var i = 0; i < json.headquarters.length; i++)
                                {
                                    var boton = '<div><button class="btn btn-info btn-md" onclick="cambiar_sede('+ json.headquarters[i].id + ',' + json.headquarters[i].x + ',' + json.headquarters[i].y + ', \'' + json.headquarters[i].name +'\');">'+ json.headquarters[i].name +'</button></div><br>';
                                    div_opciones_sodas.innerHTML += boton;
                                }
                                //Se agrega el boton de cancelar
                                var boton = '<button class="btn btn-default" onclick="cancelar();">Cancelar</button>';
                                div_opciones_sodas.innerHTML += boton;
                                document.getElementById('ajustes').appendChild(div_opciones_sodas);
                        });
                            
                    }
                    </script>
                    <button type="button" id="cambia_sedeBTN" class="btn btn-default" onclick="mostrarSedes();">Cambiar</button>
                </div>


            </div>
        </div>
    </div>

    <div id="map" class="sidebar-map"></div>

    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//maps.googleapis.com/maps/api/js" type="text/javascript"></script>
    <script src="bower_components/sidebar-v2/js/jquery-sidebar.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <script>
        var sidebar = $('#sidebar').sidebar();
        var map;
        var infoWindow;
        var actualSeleccionMenu;
        var marcadores = [];
        var menusSodaEscogida = [];
        var sodas_listado;

        function cambiarInformacionSoda(id, indice) {
            $('#form-enviar')[0].setAttribute('data-idsoda', id);
            $.ajax({
                accepts: { json : 'application/json' },
                headers: {          
                 Accept : "application/json; charset=utf-8"
                },
                url : URL_Peticiones + "/restaurants/getMenus/"+id
            }).done( function( data ) {
                var menu =  data.menus;      
                menusSodaEscogida = [];
                var infoSodaEscogida = sodas_listado[indice];
                $('#opciones-soda li').each(function () {
                    $(this).removeClass('disabled')
                });
                $('.nombre-soda-actual').each(function () {
                   $(this).text(infoSodaEscogida.name);
                });
                var textoInfo = (infoSodaEscogida.image_name != "") ? "<img id='imagen_soda' class='center-block img-thumbnail' alt='imagen "+infoSodaEscogida.name+"' src='" + infoSodaEscogida.image_name + "' /></div>" : "";
                if (infoSodaEscogida.card) {
                    textoInfo += "<p>Se acepta tarjeta de crédito o débito</p>";
                } else {
                    textoInfo += "<p>No se acepta tarjeta de crédito o débito</p>";
                }
                textoInfo += "El horario es: " + infoSodaEscogida.schedule;
                $('#informacion-soda > div').html(textoInfo);

                $(menu).each(function(){
                    cadena = "<tr>"
                    cadena += "<td>"+this.name+"</td>";
                    cadena += "<td>"+this.dishe.name+"</td>";
                    cadena += "<td>"+this.price+"</td>";
                    cadena += "</tr>";
                    if(! menusSodaEscogida[this.type.type]) menusSodaEscogida[this.type.type] = {'datos':''};
                    menusSodaEscogida[this.type.type]['datos'] += cadena;
                    menusSodaEscogida[this.type.type]['horario'] = this.type.schedule;
                });
                clasesMenu ='<ul class="nav nav-tabs" id="lista-clases-menu">';
                for(categoria in menusSodaEscogida)
                {
                    clasesMenu += '<li role="presentation" onclick="cambioMenu(\''+ categoria +'\', this)"><a href="#">'+ categoria +'</a></li>';
                    menusSodaEscogida[categoria] = "<div>Horario: " + menusSodaEscogida[categoria].horario + "</div>"
                                          + "<table class='table'><thead><th>Tipo</th><th>Nombre</th><th>Precio</th></thead>"
                                          + "<tbody>" + menusSodaEscogida[categoria].datos + "</tbody>";
                }
                clasesMenu += "</ul><div id='horario-soda'></div>";            
                $('#menu-soda > div').html(clasesMenu);
                actualSeleccionMenu = $('#lista-clases-menu li')[0];
                actualSeleccionMenu.click();
            });
        }
        
        function cambioMenu(index, nuevo)
        {
            actualSeleccionMenu.classList.remove('active');
            nuevo.classList.add('active');
            actualSeleccionMenu = nuevo;
            $('#horario-soda').html(menusSodaEscogida[index]);
        }
        function clickMarcador(id, cerrar){
            if(cerrar) sidebar.close();
            google.maps.event.trigger(marcadores[id], 'click');
        }
        function insertarSodas(idSede) {
            $.ajax({
                accepts: { json : 'application/json' },
                headers: {          
                 Accept : "application/json; charset=utf-8"
                },
                url : URL_Peticiones + "/restaurants/indexByHeadquarter/"+idSede
            }).done( function( data ) {
                sodas_listado = data.restaurants;
                var listaSodasHTML = "<div class='wrapper-list'>";
                $(sodas_listado).each(function (index) {
                    var html, point, marker, label;
                    html = "<b>" + this.name + "</b> <br/>" + "<a href=\"javascript:sidebar.open('informacion-soda')\">Ver mas info</a>";
                    point = new google.maps.LatLng(this.x, this.y);

                    marker = new google.maps.Marker({
                        map: map,
                        position: point,
                        title: this.name
                    });
                    var nId = this.id;
                    marcadores[nId] = marker;
                    google.maps.event.addListener(marker, 'click', function () {
                        infoWindow.setContent(html);
                        infoWindow.open(map, marker);
                        map.panTo(point);
                        cambiarInformacionSoda(nId, index);
                    });
                    listaSodasHTML += "<div class='thumbnail'><div class='content-t'><div class='contenedor-nombre'><p>" 
                        + this.name 
                        + `</p></div>
                            <div class="btn-group">
                              <button type="button" class="btn btn-info" onclick='clickMarcador(`+nId+`, true)'>Ver en el mapa</button>
                              <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="caret"></span>
                                <span class="sr-only">Toggle Dropdown</span>
                              </button>
                              <ul class="dropdown-menu">
                                <li><a href="#" onclick="clickMarcador(` + this.id + `, false);sidebar.open('informacion-soda');">Ver Información</a></li>
                                <li><a href="#" onclick="clickMarcador(` + this.id + `, false);sidebar.open('menu-soda');">Ver menú del día</a></li>
                                <li><a href="#" onclick="clickMarcador(` + this.id + `, false);sidebar.open('mensaje-soda');">Enviar mensaje</a></li>
                              </ul>
                            </div>`
                        + "</div></div>";
                });
                listaSodasHTML += "</div>";
                $('#lista-sodas > div').html(listaSodasHTML);
            });
        }
        
        function initialize() {
            recuperarSedes();
            map = new google.maps.Map(document.getElementById("map"), {
                center: new google.maps.LatLng(9.936336777937717, -84.05115959657292),
                zoom: 17,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                disableDefaultUI: true,
                clickableIcons: false
            });
            infoWindow = new google.maps.InfoWindow();
            google.maps.event.addListener(infoWindow, 'closeclick', function(){
                sidebar.close();
                $('#opciones-soda li').each(function () {
                    $(this).addClass('disabled');
                });
            });
            google.maps.event.addListener(map, 'click', function(event){
                infoWindow.close();
                google.maps.event.trigger(infoWindow, 'closeclick');
            });
            
        }
    </script>
    
</body>

</html>